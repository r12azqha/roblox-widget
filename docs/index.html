<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Roblox Profile Widget</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap");

      body {
        background-color: transparent; /* Transparent for OBS */
        font-family: "Inter", sans-serif;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
        overflow: hidden;
      }

      /* Roblox App Gradient Background */
      .roblox-app-bg {
        background: radial-gradient(
          circle at 50% 30%,
          #4a4d52 0%,
          #1a1c1e 60%,
          #111213 100%
        );
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      }

      /* Stats Pills */
      .stat-pill {
        background-color: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        transition: background-color 0.2s;
      }

      /* Loading shimmer for text */
      .animate-pulse-fast {
        animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      /* Sparkle Animation */
      .sparkle {
        position: absolute;
        width: 20px;
        height: 20px;
        background: white;
        clip-path: polygon(
          50% 0%,
          61% 35%,
          98% 35%,
          68% 57%,
          79% 91%,
          50% 70%,
          21% 91%,
          32% 57%,
          2% 35%,
          39% 35%
        );
        opacity: 0;
        animation: sparkleAnim 3s infinite ease-in-out;
        box-shadow: 0 0 10px 2px rgba(255, 255, 255, 0.8);
      }

      @keyframes sparkleAnim {
        0% {
          transform: scale(0) rotate(0deg);
          opacity: 0;
        }
        50% {
          transform: scale(1) rotate(45deg);
          opacity: 0.8;
        }
        100% {
          transform: scale(0) rotate(90deg);
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <!-- MAIN WIDGET CONTAINER -->
    <div
      id="widget-container"
      class="hidden roblox-app-bg w-[400px] h-auto min-h-[480px] rounded-[24px] relative overflow-hidden flex flex-col text-white pb-6"
    >
      <!-- Top Section: Avatar -->
      <div class="relative h-[320px] w-full flex justify-center items-end pb-4">
        <!-- Sparkles -->
        <div
          class="sparkle"
          style="top: 20%; left: 20%; animation-delay: 0s"
        ></div>
        <div
          class="sparkle"
          style="
            top: 30%;
            right: 20%;
            animation-delay: 1s;
            width: 15px;
            height: 15px;
          "
        ></div>
        <div
          class="sparkle"
          style="
            top: 50%;
            left: 15%;
            animation-delay: 2s;
            width: 10px;
            height: 10px;
          "
        ></div>

        <!-- Avatar Image -->
        <!-- Changed: Initial src is transparent pixel, no fallback placeholder -->
        <img
          id="avatar-img"
          src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
          alt="Avatar"
          class="h-[300px] object-contain drop-shadow-2xl z-10 transition-all duration-500 hover:scale-105 opacity-0"
          style="
            mask-image: linear-gradient(to bottom, black 90%, transparent 100%);
          "
        />
      </div>

      <!-- Info Section -->
      <div class="px-6 -mt-4 z-20">
        <!-- Name Block -->
        <div class="mb-4">
          <div class="flex items-center gap-2">
            <h1
              id="display-name"
              class="text-2xl font-bold tracking-tight animate-pulse-fast"
            >
              Searching...
            </h1>
          </div>
          <!-- Username Handle -->
          <p id="username-handle" class="text-gray-400 text-xs mt-1">@...</p>
        </div>

        <!-- Stats Pills -->
        <div class="flex flex-wrap gap-2 mb-6">
          <div
            class="stat-pill px-3 py-2 rounded-xl flex items-center gap-1 cursor-default flex-1 justify-center"
          >
            <span
              id="connections-count"
              class="font-bold text-base animate-pulse-fast"
              >-</span
            >
            <span class="text-gray-300 text-xs font-medium">Connections</span>
          </div>
          <div
            class="stat-pill px-3 py-2 rounded-xl flex items-center gap-1 cursor-default flex-1 justify-center"
          >
            <span
              id="followers-count"
              class="font-bold text-base animate-pulse-fast"
              >-</span
            >
            <span class="text-gray-300 text-xs font-medium">Followers</span>
          </div>
          <div
            class="stat-pill px-3 py-2 rounded-xl flex items-center gap-1 cursor-default flex-1 justify-center"
          >
            <span
              id="following-count"
              class="font-bold text-base animate-pulse-fast"
              >-</span
            >
            <span class="text-gray-300 text-xs font-medium">Following</span>
          </div>
        </div>

        <!-- Bio & Join Date -->
        <div class="space-y-3">
          <div
            class="text-gray-200 text-sm font-normal leading-relaxed whitespace-pre-line break-words max-h-28 overflow-hidden text-ellipsis relative animate-pulse-fast"
            id="bio-text"
          >
            Loading bio...
          </div>

          <div class="pt-3 border-t border-white/10">
            <p
              id="join-date"
              class="text-gray-500 text-[10px] uppercase font-semibold tracking-wider"
            >
              Joined: ...
            </p>
          </div>
        </div>
      </div>
    </div>

    <script>
      lucide.createIcons();

      const els = {
        widgetContainer: document.getElementById("widget-container"),
        avatar: document.getElementById("avatar-img"),
        displayName: document.getElementById("display-name"),
        handle: document.getElementById("username-handle"),
        connections: document.getElementById("connections-count"),
        followers: document.getElementById("followers-count"),
        following: document.getElementById("following-count"),
        bio: document.getElementById("bio-text"),
        joinDate: document.getElementById("join-date"),
      };

      // --- REDIRECT LOGIC ---
      const params = new URLSearchParams(window.location.search);
      const rawUser = params.get("username");
      const fallbackUser = "12azqha";

      // Removed fallback placeholder image constant

      if (!rawUser) {
        const newUrl = new URL(window.location.href);
        newUrl.searchParams.set("username", fallbackUser);
        window.location.replace(newUrl.toString());
      } else {
        els.widgetContainer.classList.remove("hidden");
        els.widgetContainer.classList.add("flex");
        init(rawUser.trim());
      }

      // --- Robust Proxy Helper ---
      async function fetchProxy(targetUrl) {
        const separator = targetUrl.includes("?") ? "&" : "?";
        const cacheBuster = `${separator}_t=${Date.now()}`;

        try {
          // Try Primary Proxy
          const r1 = await fetch(
            `https://api.allorigins.win/raw?url=${encodeURIComponent(
              targetUrl
            )}&disableCache=true&_t=${Date.now()}`
          );
          if (r1.ok) return await r1.json();
          throw new Error("Primary proxy failed");
        } catch (e) {
          // Try Backup Proxy
          const urlWithCache = targetUrl + cacheBuster;
          const r2 = await fetch(
            `https://corsproxy.io/?${encodeURIComponent(urlWithCache)}`
          );
          if (r2.ok) return await r2.json();
          throw new Error("All proxies failed");
        }
      }

      // --- Independent Avatar Tracker Logic ---
      async function trackAvatar(userId) {
        const run = async () => {
          try {
            const avatarUrl = `https://thumbnails.roblox.com/v1/users/avatar?userIds=${userId}&size=720x720&format=Png&isCircular=false`;
            const data = await fetchProxy(avatarUrl);

            // Check if image is ready
            if (
              data.data &&
              data.data[0].state === "Completed" &&
              data.data[0].imageUrl
            ) {
              const imgUrl = data.data[0].imageUrl;
              // Preload before showing
              const newImg = new Image();
              newImg.onload = () => {
                els.avatar.src = imgUrl;
                // Fade in
                els.avatar.classList.remove("opacity-0", "animate-pulse-fast");
              };
              newImg.src = imgUrl;
            } else {
              throw new Error("Avatar not ready or pending");
            }
          } catch (e) {
            // On fail: Keep transparent, retry in 5s
            // Ensure pulse/opacity classes are reset for retry state if needed
            // (Though if it's opacity-0, pulsing isn't visible, but logic is consistent)
            setTimeout(run, 5000);
          }
        };
        run();
      }

      // --- Independent Stat Tracker Logic ---
      async function trackStat({
        element,
        url,
        extractValue,
        formatValue,
        type,
      }) {
        const run = async () => {
          try {
            const data = await fetchProxy(url);
            const val = extractValue(data);

            // Check Validation Logic based on type
            let isValid = false;

            if (type === "number") {
              // For stats: valid if > 0
              isValid = typeof val === "number" && val > 0;
            } else if (type === "text") {
              // For bio: valid if not empty
              isValid = val && val.trim().length > 0;
            }

            if (isValid) {
              // Success! Stop flashing, show value
              element.classList.remove("animate-pulse-fast");
              element.innerText = formatValue ? formatValue(val) : val;

              // Also update join date if this was the bio fetch (since they share endpoint)
              if (type === "text" && data.created) {
                const date = new Date(data.created);
                els.joinDate.innerText = `Joined: ${date.toLocaleDateString(
                  "en-US",
                  { year: "numeric", month: "short", day: "numeric" }
                )}`;
              }
            } else {
              throw new Error("Value is 0 or empty");
            }
          } catch (err) {
            // On Error or invalid value:
            element.classList.add("animate-pulse-fast");

            if (type === "number") element.innerText = "-";
            if (type === "text") element.innerText = "Loading bio...";

            // Retry in 5 seconds
            setTimeout(run, 5000);
          }
        };

        // Start the loop
        run();
      }

      // --- Main Init Flow ---
      async function init(targetUsername) {
        // Reset UI
        els.handle.innerText = `@${targetUsername}`;
        els.displayName.innerText = "Searching...";
        els.displayName.classList.add("animate-pulse-fast");
        // Clear avatar to transparent pixel
        els.avatar.src =
          "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
        els.avatar.classList.add("opacity-0");

        // Set initial state for stats (flashing dash)
        [els.connections, els.followers, els.following].forEach((el) => {
          el.innerText = "-";
          el.classList.add("animate-pulse-fast");
        });
        els.bio.innerText = "Loading bio...";
        els.bio.classList.add("animate-pulse-fast");

        try {
          // 1. FIRST: Find the User (Critical Step)
          const userSearchUrl = `https://users.roblox.com/v1/users/search?keyword=${targetUsername}&limit=10`;
          const searchData = await fetchProxy(userSearchUrl);

          const user = searchData.data.find(
            (u) => u.name.toLowerCase() === targetUsername.toLowerCase()
          );

          if (!user) {
            els.displayName.innerText = "Not Found";
            els.bio.innerText = `User @${targetUsername} not found.`;
            els.displayName.classList.remove("animate-pulse-fast");
            els.bio.classList.remove("animate-pulse-fast");
            return; // Stop everything if user doesn't exist
          }

          // 2. User Found - Update Identity
          const userId = user.id;
          els.displayName.innerText = user.displayName;
          els.displayName.classList.remove("animate-pulse-fast");
          els.handle.innerText = `@${user.name}`;

          // 3. Start Independent Loops

          // Start Avatar Loop
          trackAvatar(userId);

          // Formatter for numbers (1.5k)
          const fmt = (n) => (n > 999 ? (n / 1000).toFixed(1) + "k" : n);

          // Friends/Connections
          trackStat({
            element: els.connections,
            url: `https://friends.roblox.com/v1/users/${userId}/friends/count`,
            extractValue: (d) => d.count,
            formatValue: fmt,
            type: "number",
          });

          // Followers
          trackStat({
            element: els.followers,
            url: `https://friends.roblox.com/v1/users/${userId}/followers/count`,
            extractValue: (d) => d.count,
            formatValue: fmt,
            type: "number",
          });

          // Following
          trackStat({
            element: els.following,
            url: `https://friends.roblox.com/v1/users/${userId}/followings/count`,
            extractValue: (d) => d.count,
            formatValue: fmt,
            type: "number",
          });

          // Bio
          trackStat({
            element: els.bio,
            url: `https://users.roblox.com/v1/users/${userId}`,
            extractValue: (d) => d.description,
            type: "text",
          });
        } catch (err) {
          console.error("Critical Init Error:", err);
          els.displayName.innerText = "Connection Error";
          els.displayName.classList.remove("animate-pulse-fast");
          setTimeout(() => window.location.reload(), 5000);
        }
      }
    </script>
  </body>
</html>
